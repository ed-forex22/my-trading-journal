<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 
        Chosen Palette: Calm Neutral / Dark Mode Enhanced
        - Light Mode:
            - Background: #F8F9FA (Off-white)
            - Text: #212529 (Dark Gray)
            - Primary Accent: #4A5568 (Slate Gray)
            - Win/Positive: #2F855A (Green)
            - Loss/Negative: #C53030 (Red)
            - Neutral/Info: #2B6CB0 (Blue)
        - Dark Mode:
            - Background: #1A202C (Dark Blue-Gray)
            - Card Background: #2D3748 (Slightly Lighter Dark Blue-Gray)
            - Text: #E2E8F0 (Light Gray)
            - Primary Accent: #A0AEC0 (Medium Gray)
            - Win/Positive: #38A169 (Brighter Green)
            - Loss/Negative: #E53E3E (Brighter Red)
            - Neutral/Info: #63B3ED (Brighter Blue)
    -->
    <!-- 
        Application Structure Plan: The application is designed as a single-page interactive dashboard. This structure was chosen to provide the trader with a comprehensive, at-a-glance overview of their performance, which is the primary goal of a trading journal. The layout consists of three main parts: 1) A high-level KPI section for immediate feedback on key metrics (P&L, Win Rate). 2) A visual analysis section with interactive charts to identify trends and patterns in performance, strategy, and psychology. 3) A detailed, filterable trade log table for granular review. A modal form for data entry keeps the main interface clean. This non-linear, dashboard approach is superior to a simple document layout because it facilitates active analysis and exploration, allowing the user to seamlessly move from a high-level overview to detailed trade inspection.
    -->
    <!-- 
        Visualization & Content Choices: 
        - Report Info: Key Performance Metrics (Total P&L, Win Rate, Avg. R:R, Total Trades). Goal: Inform. Viz/Method: Styled stat cards (HTML/CSS). Interaction: None. Justification: Provides immediate, high-level feedback on performance. Library: N/A.
        - Report Info: Cumulative P&L over time. Goal: See Change/Trend. Viz/Method: Line Chart. Interaction: Hover tooltips for specific values. Justification: Visualizes account growth and identifies performance periods. Library: Chart.js.
        - Report Info: Trade Outcomes (Win/Loss/BE). Goal: Show Proportions. Viz/Method: Doughnut Chart. Interaction: Hover tooltips for counts/percentages. Justification: Gives a quick understanding of the win/loss distribution. Library: Chart.js.
        - Report Info: P&L by Trading Strategy. Goal: Compare. Viz/Method: Horizontal Bar Chart. Interaction: Hover tooltips. Justification: Clearly identifies which strategies are working and which are not, a core analysis function. Library: Chart.js.
        - Report Info: All individual trade data points. Goal: Organize & Detail. Viz/Method: Interactive HTML Table. Interaction: Filter by result/strategy, sort, and view details in a modal. Justification: This is the core data repository, allowing for in-depth, flexible analysis of every trade. Library: N/A.
        - Report Info: Data entry for a new trade. Goal: User Input. Viz/Method: Modal form. Interaction: Standard form elements. Justification: Creates the core functionality of the application, allowing users to populate the journal with their own data. Library: N/A.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <title>Interactive Day Trading Journal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        :root {
            /* Light Theme */
            --bg-color: #F8F9FA;
            --card-bg: #FFFFFF;
            --text-primary: #212529;
            --text-secondary: #4A5568;
            --border-color: #E2E8F0;
            --win: #2F855A;
            --loss: #C53030;
            --breakeven: #4A5568;
            --accent: #2B6CB0;
            --button-text: #FFFFFF;
            --button-bg: #2B6CB0;
            --button-hover-bg: #2C5282;
            --table-header-bg: #F9FAFB;
        }

        [data-theme='dark'] {
            /* Dark Theme */
            --bg-color: #1A202C;
            --card-bg: #2D3748;
            --text-primary: #E2E8F0;
            --text-secondary: #A0AEC0;
            --border-color: #4A5568;
            --win: #38A169;
            --loss: #E53E3E;
            --breakeven: #A0AEC0;
            --accent: #63B3ED;
            --button-text: #1A202C;
            --button-bg: #63B3ED;
            --button-hover-bg: #4299E1;
            --table-header-bg: #4A5568;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .chart-container {
            position: relative;
            background-color: var(--card-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03);
            width: 100%;
            height: 350px;
            max-height: 400px;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .modal {
            transition: opacity 0.25s ease;
        }
        .modal-overlay {
            background-color: var(--text-primary); /* Use primary text color for overlay for consistency */
            opacity: 0.5;
        }
        .modal-container {
            background-color: var(--card-bg);
            transition: background-color 0.3s ease;
        }
        .modal-active {
            overflow-x: hidden;
            overflow-y: auto;
        }
        .win-text { color: var(--win); }
        .loss-text { color: var(--loss); }
        .breakeven-text { color: var(--breakeven); }
        .screenshot-placeholder {
            background-color: var(--bg-color); /* Matches current background for seamless look */
            border: 1px dashed var(--border-color);
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            font-size: 0.875rem;
            text-align: center;
            border-radius: 0.25rem;
            overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .screenshot-placeholder img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        /* Table styling for dark mode */
        table {
            color: var(--text-secondary);
        }
        thead {
            background-color: var(--table-header-bg);
            color: var(--text-primary);
        }
        tbody tr {
            background-color: var(--card-bg);
            border-color: var(--border-color);
        }
        tbody tr:hover {
            background-color: var(--bg-color);
        }
        .text-gray-800 { color: var(--text-primary); }
        .text-gray-500 { color: var(--text-secondary); }
        .text-gray-700 { color: var(--text-primary); }
        .bg-gray-50 { background-color: var(--table-header-bg); }
        .bg-white { background-color: var(--card-bg); }
        .border-gray-200 { border-color: var(--border-color); }
        .border-gray-300 { border-color: var(--border-color); }
        .bg-blue-600 { background-color: var(--button-bg); }
        .hover\:bg-blue-700:hover { background-color: var(--button-hover-bg); }
        .bg-red-600 { background-color: var(--loss); }
        .hover\:bg-red-700:hover { background-color: #B22020; } /* Slightly darker red for hover */
        .text-black { color: var(--text-primary); } /* For close button SVG */
        .bg-green-100 { background-color: rgba(47, 133, 90, 0.2); } /* Adjusted for general bg */
        .bg-red-100 { background-color: rgba(197, 48, 48, 0.2); } /* Adjusted for general bg */
        .bg-gray-100 { background-color: rgba(74, 85, 104, 0.2); } /* Adjusted for general bg */
        .file-upload-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .file-input-wrapper {
            display: flex;
            align-items: center;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            overflow: hidden;
            background-color: var(--card-bg);
            position: relative;
        }
        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .file-input-wrapper .file-label {
            flex-grow: 1;
            padding: 0.5rem 0.75rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .file-input-wrapper .file-button {
            background-color: var(--button-bg);
            color: var(--button-text);
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .file-input-wrapper .file-button:hover {
            background-color: var(--button-hover-bg);
        }
    </style>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
</head>
<body class="antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-8 flex justify-between items-center relative">
            <!-- Light/Dark Mode Toggle -->
            <div class="absolute top-0 left-0 mt-2 ml-2 md:mt-4 md:ml-4">
                <button id="themeToggle" class="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 shadow-md transition-colors duration-300">
                    <span id="themeIcon" class="text-xl">üåô</span>
                </button>
            </div>

            <div class="w-full text-center md:text-left md:ml-20">
                <h1 class="text-3xl font-bold text-gray-800">Day Trading Journal</h1>
                <p class="text-gray-500 mt-1">Transform your trade data into actionable insights.</p>
            </div>
            <button id="addTradeBtn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 ml-auto">
                + Add Trade
            </button>
        </header>

        <main>
            <!-- KPIs Section -->
            <section id="kpi-section" class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Performance Dashboard</h2>
                 <p class="text-gray-500 mb-4 text-sm max-w-4xl">
                    This section provides a high-level, real-time overview of your trading performance. Key Performance Indicators (KPIs) like Total P&L, Win Rate, and Average Risk-to-Reward Ratio help you quickly assess your profitability and effectiveness without needing to dig into individual trades. Use this dashboard for a daily check on your financial progress and trading discipline.
                </p>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                        <h3 class="text-sm font-medium text-gray-500">Total P&L</h3>
                        <p id="kpi-total-pnl" class="text-2xl font-bold mt-1">$0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                        <h3 class="text-sm font-medium text-gray-500">Win Rate</h3>
                        <p id="kpi-win-rate" class="text-2xl font-bold mt-1">0%</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                        <h3 class="text-sm font-medium text-gray-500">Avg. R:R</h3>
                        <p id="kpi-avg-rr" class="text-2xl font-bold mt-1">0.00</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg border border-gray-200 shadow-sm">
                        <h3 class="text-sm font-medium text-gray-500">Total Trades</h3>
                        <p id="kpi-total-trades" class="text-2xl font-bold mt-1">0</p>
                    </div>
                </div>
            </section>

            <!-- Charts Section -->
            <section id="charts-section" class="mb-8">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Visual Analysis</h2>
                 <p class="text-gray-500 mb-4 text-sm max-w-4xl">
                    Visualizations offer the quickest way to identify trends and patterns. The charts below break down your performance over time and by category. The Cumulative P&L chart tracks your account's growth, the Outcomes chart shows your win/loss distribution, and the Strategy Performance chart reveals which of your trading strategies are most effective. Use these visuals to refine your approach and focus on what works.
                </p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="chart-container">
                        <canvas id="pnlChart"></canvas>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="chart-container !h-auto">
                            <canvas id="winLossChart"></canvas>
                        </div>
                        <div class="chart-container !h-auto">
                            <canvas id="strategyChart"></canvas>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Trade Log Section -->
            <section id="trade-log-section">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Trade Log</h2>
                 <p class="text-gray-500 mb-4 text-sm max-w-4xl">
                    Here is the detailed log of every trade you've taken. This table allows for granular analysis. You can sort by any column or use the filters to narrow down your view, for example, to see all trades for a specific asset or strategy. Click on any trade row to see the full details, including your notes and chart screenshots.
                </p>
                 <div class="flex flex-wrap gap-4 mb-4 items-center">
                    <select id="filter-strategy" class="bg-white border border-gray-300 rounded-md py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                        <option value="all">All Strategies</option>
                    </select>
                    <select id="filter-result" class="bg-white border border-gray-300 rounded-md py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-800">
                        <option value="all">All Results</option>
                        <option value="win">‚úÖ Win</option>
                        <option value="loss">‚ùå Loss</option>
                        <option value="breakeven">‚ûñ Break Even</option>
                    </select>
                </div>
                <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-x-auto">
                    <table class="w-full text-sm text-left text-gray-500">
                        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Date</th>
                                <th scope="col" class="px-6 py-3">Asset</th>
                                <th scope="col" class="px-6 py-3">Direction</th>
                                <th scope="col" class="px-6 py-3">Strategy</th>
                                <th scope="col" class="px-6 py-3">P&L ($)</th>
                                <th scope="col" class="px-6 py-3">R:R</th>
                                <th scope="col" class="px-6 py-3">Result</th>
                            </tr>
                        </thead>
                        <tbody id="trade-log-body">
                            <!-- JS will populate this -->
                        </tbody>
                    </table>
                     <div id="no-trades-message" class="text-center p-8 text-gray-500 hidden">
                        <p>No trades logged yet. Click "+ Add Trade" to get started.</p>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Add New Trade Modal -->
    <div id="addTradeModal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center hidden">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded-lg shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold text-gray-800">Log a New Trade</p>
                    <button id="closeAddModalBtn" class="cursor-pointer z-50">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                        </svg>
                    </button>
                </div>

                <form id="addTradeForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <label class="block text-gray-700 font-bold mb-1">Asset</label>
                        <input type="text" id="addAsset" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., EUR/USD, AAPL" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-1">Direction</label>
                        <select id="addDirection" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" required>
                            <option value="long">üü¢ Long</option>
                            <option value="short">üî¥ Short</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-1">Strategy Used</label>
                        <input type="text" id="addStrategy" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Breakout, Reversal" required>
                    </div>
                     <div>
                        <label class="block text-gray-700 font-bold mb-1">Date</label>
                        <input type="datetime-local" id="addDate" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-bold mb-1">Entry Price</label>
                            <input type="number" step="any" id="addEntryPrice" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-bold mb-1">Exit Price</label>
                            <input type="number" step="any" id="addExitPrice" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                         <div>
                            <label class="block text-gray-700 font-bold mb-1">Stop Loss</label>
                            <input type="number" step="any" id="addStopLoss" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-bold mb-1">Take Profit</label>
                            <input type="number" step="any" id="addTakeProfit" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                     <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-bold mb-1">Risk ($)</label>
                            <input type="number" step="any" id="addRisk" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Amount risked" required>
                        </div>
                        <div>
                             <label class="block text-gray-700 font-bold mb-1">P&L ($)</label>
                            <input type="number" step="any" id="addPnl" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Actual gain/loss" required>
                        </div>
                    </div>
                     <div>
                        <label class="block text-gray-700 font-bold mb-1">Emotions</label>
                        <input type="text" id="addEmotions" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Confident, Anxious">
                    </div>

                    <div>
                        <label class="block text-gray-700 font-bold mb-1">Trading Notes (Reasoning)</label>
                        <textarea id="addTradingNotes" rows="4" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Why did you take this trade?"></textarea>
                    </div>
                     <div>
                        <label class="block text-gray-700 font-bold mb-1">Lessons Learned</label>
                        <textarea id="addLessonsLearned" rows="4" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="What was the key takeaway?"></textarea>
                    </div>
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="file-upload-container">
                            <label class="block text-gray-700 font-bold mb-1">Setup Screenshot</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="addSetupScreenshot" accept="image/*">
                                <span class="file-label" id="addSetupScreenshotFileName">Choose File...</span>
                                <span class="file-button">Browse</span>
                            </div>
                            <button type="button" id="analyzeAddSetupBtn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-300 text-sm mt-2">Analyze Setup Screenshot</button>
                            <div id="addSetupScreenshotPreview" class="screenshot-placeholder mt-2">
                                <span class="text-gray-500">No Setup Screenshot Selected</span>
                            </div>
                            <p id="addSetupAnalysisStatus" class="text-gray-600 text-xs mt-1"></p>
                        </div>
                        <div class="file-upload-container">
                            <label class="block text-gray-700 font-bold mb-1">Exit Screenshot</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="addExitScreenshot" accept="image/*">
                                <span class="file-label" id="addExitScreenshotFileName">Choose File...</span>
                                <span class="file-button">Browse</span>
                            </div>
                             <button type="button" id="analyzeAddExitBtn" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition duration-300 text-sm mt-2">Analyze Exit Screenshot</button>
                            <div id="addExitScreenshotPreview" class="screenshot-placeholder mt-2">
                                <span class="text-gray-500">No Exit Screenshot Selected</span>
                            </div>
                            <p id="addExitAnalysisStatus" class="text-gray-600 text-xs mt-1"></p>
                        </div>
                    </div>
                    <div class="md:col-span-2 mt-4 flex justify-end">
                         <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">Save Trade</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Trade Details/Edit Modal -->
    <div id="tradeDetailsModal" class="modal fixed w-full h-full top-0 left-0 flex items-center justify-center hidden">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-3xl mx-auto rounded-lg shadow-lg z-50 overflow-y-auto max-h-[90vh]">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold text-gray-800">Trade Details & Edit</p>
                    <button id="closeDetailsModalBtn" class="cursor-pointer z-50">
                        <svg class="fill-current text-black" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 18 18">
                            <path d="M14.53 4.53l-1.06-1.06L9 7.94 4.53 3.47 3.47 4.53 7.94 9l-4.47 4.47 1.06 1.06L9 10.06l4.47 4.47 1.06-1.06L10.06 9z"></path>
                        </svg>
                    </button>
                </div>

                <form id="tradeDetailsForm" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <input type="hidden" id="detailsTradeId">
                    <div>
                        <label class="block text-gray-700 font-bold mb-1">Asset</label>
                        <input type="text" id="detailsAsset" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., EUR/USD, AAPL" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-1">Direction</label>
                        <select id="detailsDirection" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" required>
                            <option value="long">üü¢ Long</option>
                            <option value="short">üî¥ Short</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 font-bold mb-1">Strategy Used</label>
                        <input type="text" id="detailsStrategy" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Breakout, Reversal" required>
                    </div>
                     <div>
                        <label class="block text-gray-700 font-bold mb-1">Date</label>
                        <input type="datetime-local" id="detailsDate" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-bold mb-1">Entry Price</label>
                            <input type="number" step="any" id="detailsEntryPrice" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-bold mb-1">Exit Price</label>
                            <input type="number" step="any" id="detailsExitPrice" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                         <div>
                            <label class="block text-gray-700 font-bold mb-1">Stop Loss</label>
                            <input type="number" step="any" id="detailsStopLoss" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-gray-700 font-bold mb-1">Take Profit</label>
                            <input type="number" step="any" id="detailsTakeProfit" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                     <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 font-bold mb-1">Risk ($)</label>
                            <input type="number" step="any" id="detailsRisk" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Amount risked" required>
                        </div>
                        <div>
                             <label class="block text-gray-700 font-bold mb-1">P&L ($)</label>
                            <input type="number" step="any" id="detailsPnl" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Actual gain/loss" required>
                        </div>
                    </div>
                     <div>
                        <label class="block text-gray-700 font-bold mb-1">Emotions</label>
                        <input type="text" id="detailsEmotions" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., Confident, Anxious">
                    </div>

                    <div>
                        <label class="block text-gray-700 font-bold mb-1">Trading Notes (Reasoning)</label>
                        <textarea id="detailsTradingNotes" rows="4" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="Why did you take this trade?"></textarea>
                    </div>
                     <div>
                        <label class="block text-gray-700 font-bold mb-1">Lessons Learned</label>
                        <textarea id="detailsLessonsLearned" rows="4" class="w-full px-3 py-2 border rounded text-gray-800 bg-white border-gray-300 focus:ring-blue-500 focus:border-blue-500" placeholder="What was the key takeaway?"></textarea>
                    </div>
                    <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="file-upload-container">
                            <label class="block text-gray-700 font-bold mb-1">Setup Screenshot</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="detailsSetupScreenshot" accept="image/*">
                                <span class="file-label" id="detailsSetupScreenshotFileName">Choose File...</span>
                                <span class="file-button">Browse</span>
                            </div>
                            <div id="detailsSetupScreenshotPreview" class="screenshot-placeholder mt-2">
                                <span class="text-gray-500">No Setup Screenshot</span>
                            </div>
                        </div>
                        <div class="file-upload-container">
                            <label class="block text-gray-700 font-bold mb-1">Exit Screenshot</label>
                            <div class="file-input-wrapper">
                                <input type="file" id="detailsExitScreenshot" accept="image/*">
                                <span class="file-label" id="detailsExitScreenshotFileName">Choose File...</span>
                                <span class="file-button">Browse</span>
                            </div>
                            <div id="detailsExitScreenshotPreview" class="screenshot-placeholder mt-2">
                                <span class="text-gray-500">No Exit Screenshot</span>
                            </div>
                        </div>
                    </div>
                    <div class="md:col-span-2 mt-4 flex justify-between">
                        <button type="button" id="deleteTradeBtn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-red-700 transition duration-300">Delete Trade</button>
                        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // --- DATA ---
            // Sample data with added screenshot (Base64) or placeholder URLs
            let trades = [
                { id: 1, date: '2025-06-18T09:30:00', asset: 'EUR/USD', direction: 'long', strategy: 'Breakout', entryPrice: 1.0750, exitPrice: 1.0780, stopLoss: 1.0740, takeProfit: 1.0790, risk: 50, pnl: 150, emotions: 'Confident', notes: 'Clear breakout above resistance.', lessons: 'Good entry, respected plan.', setupScreenshot: 'https://placehold.co/300x200/4CAF50/FFFFFF?text=Setup+1', exitScreenshot: 'https://placehold.co/300x200/FFC107/FFFFFF?text=Exit+1' },
                { id: 2, date: '2025-06-18T11:05:00', asset: 'SPY', direction: 'short', strategy: 'Reversal', entryPrice: 548.50, exitPrice: 549.00, stopLoss: 549.50, takeProfit: 547.00, risk: 100, pnl: -100, emotions: 'Anxious, Impatient', notes: 'Forced the trade, no clear signal.', lessons: 'Do not trade without confirmation.', setupScreenshot: 'https://placehold.co/300x200/F44336/FFFFFF?text=Setup+2', exitScreenshot: 'https://placehold.co/300x200/2196F3/FFFFFF?text=Exit+2' },
                { id: 3, date: '2025-06-19T10:15:00', asset: 'Gold', direction: 'long', strategy: 'Trend Following', entryPrice: 2330, exitPrice: 2345, stopLoss: 2325, takeProfit: 2350, risk: 250, pnl: 750, emotions: 'Disciplined', notes: 'Followed the trend on the 1H chart.', lessons: 'Trend is your friend.', setupScreenshot: '', exitScreenshot: '' },
                { id: 4, date: '2025-06-20T14:00:00', asset: 'AAPL', direction: 'long', strategy: 'News Trading', entryPrice: 214, exitPrice: 213.50, stopLoss: 213, takeProfit: 216, risk: 100, pnl: -50, emotions: 'Frustrated', notes: 'News was positive but market reacted negatively.', lessons: 'Market reaction is what matters, not the news itself.', setupScreenshot: 'https://placehold.co/300x200/9C27B0/FFFFFF?text=Setup+4', exitScreenshot: 'https://placehold.co/300x200/E91E63/FFFFFF?text=Exit+4' },
                { id: 5, date: '2025-06-21T09:45:00', asset: 'EUR/USD', direction: 'short', strategy: 'Scalping', entryPrice: 1.0720, exitPrice: 1.0710, stopLoss: 1.0725, takeProfit: 1.0705, risk: 25, pnl: 50, emotions: 'Calm', notes: 'Quick scalp off the 5min resistance.', lessons: 'Scalping strategy is effective in this range.', setupScreenshot: 'https://placehold.co/300x200/00BCD4/FFFFFF?text=Setup+5', exitScreenshot: 'https://placehold.co/300x200/FF9800/FFFFFF?text=Exit+5' }
            ];

            // --- CHART INSTANCES ---
            let pnlChartInstance, winLossChartInstance, strategyChartInstance;

            // --- DOM ELEMENTS ---
            const tradeLogBody = document.getElementById('trade-log-body');
            const noTradesMessage = document.getElementById('no-trades-message');
            const kpiTotalPnl = document.getElementById('kpi-total-pnl');
            const kpiWinRate = document.getElementById('kpi-win-rate');
            const kpiAvgRr = document.getElementById('kpi-avg-rr');
            const kpiTotalTrades = document.getElementById('kpi-total-trades');
            
            // Add Trade Modal elements
            const addTradeModal = document.getElementById('addTradeModal');
            const addTradeBtn = document.getElementById('addTradeBtn');
            const closeAddModalBtn = document.getElementById('closeAddModalBtn');
            const addTradeForm = document.getElementById('addTradeForm');
            const addSetupScreenshot = document.getElementById('addSetupScreenshot');
            const addExitScreenshot = document.getElementById('addExitScreenshot');
            const addSetupScreenshotPreview = document.getElementById('addSetupScreenshotPreview');
            const addExitScreenshotPreview = document.getElementById('addExitScreenshotPreview');
            const addSetupScreenshotFileName = document.getElementById('addSetupScreenshotFileName');
            const addExitScreenshotFileName = document.getElementById('addExitScreenshotFileName');
            const analyzeAddSetupBtn = document.getElementById('analyzeAddSetupBtn');
            const analyzeAddExitBtn = document.getElementById('analyzeAddExitBtn');
            const addSetupAnalysisStatus = document.getElementById('addSetupAnalysisStatus');
            const addExitAnalysisStatus = document.getElementById('addExitAnalysisStatus');


            // Trade Details/Edit Modal elements
            const tradeDetailsModal = document.getElementById('tradeDetailsModal');
            const closeDetailsModalBtn = document.getElementById('closeDetailsModalBtn');
            const tradeDetailsForm = document.getElementById('tradeDetailsForm');
            const deleteTradeBtn = document.getElementById('deleteTradeBtn');
            const detailsTradeId = document.getElementById('detailsTradeId');
            const detailsAsset = document.getElementById('detailsAsset');
            const detailsDirection = document.getElementById('detailsDirection');
            const detailsStrategy = document.getElementById('detailsStrategy');
            const detailsDate = document.getElementById('detailsDate');
            const detailsEntryPrice = document.getElementById('detailsEntryPrice');
            const detailsExitPrice = document.getElementById('detailsExitPrice');
            const detailsStopLoss = document.getElementById('detailsStopLoss');
            const detailsTakeProfit = document.getElementById('detailsTakeProfit');
            const detailsRisk = document.getElementById('detailsRisk');
            const detailsPnl = document.getElementById('detailsPnl');
            const detailsEmotions = document.getElementById('detailsEmotions');
            const detailsTradingNotes = document.getElementById('detailsTradingNotes');
            const detailsLessonsLearned = document.getElementById('detailsLessonsLearned');
            const detailsSetupScreenshot = document.getElementById('detailsSetupScreenshot');
            const detailsExitScreenshot = document.getElementById('detailsExitScreenshot');
            const detailsSetupScreenshotPreview = document.getElementById('detailsSetupScreenshotPreview');
            const detailsExitScreenshotPreview = document.getElementById('detailsExitScreenshotPreview');
            const detailsSetupScreenshotFileName = document.getElementById('detailsSetupScreenshotFileName');
            const detailsExitScreenshotFileName = document.getElementById('detailsExitScreenshotFileName');


            const filterStrategy = document.getElementById('filter-strategy');
            const filterResult = document.getElementById('filter-result');

            // Theme toggle elements
            const themeToggleBtn = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');

            // --- THEME LOGIC ---
            const loadTheme = () => {
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.documentElement.setAttribute('data-theme', savedTheme);
                themeIcon.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            };

            const toggleTheme = () => {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                themeIcon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                // Re-render charts to pick up new colors
                renderAll();
            };

            themeToggleBtn.addEventListener('click', toggleTheme);
            loadTheme(); // Load theme on initial page load

            // --- MODAL LOGIC ---
            const openModal = (modalElement) => {
                modalElement.classList.remove('hidden');
                document.body.classList.add('overflow-hidden'); // Prevent scrolling behind modal
            };
            const closeModal = (modalElement) => {
                modalElement.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            };
            
            addTradeBtn.addEventListener('click', () => {
                addTradeForm.reset();
                addSetupScreenshotPreview.innerHTML = '<span class="text-gray-500">No Setup Screenshot Selected</span>';
                addExitScreenshotPreview.innerHTML = '<span class="text-gray-500">No Exit Screenshot Selected</span>';
                addSetupScreenshotFileName.textContent = 'Choose File...';
                addExitScreenshotFileName.textContent = 'Choose File...';
                addSetupAnalysisStatus.textContent = '';
                addExitAnalysisStatus.textContent = '';
                // Set default date to current local time
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                document.getElementById('addDate').value = now.toISOString().slice(0, 16);
                openModal(addTradeModal);
            });
            closeAddModalBtn.addEventListener('click', () => closeModal(addTradeModal));
            addTradeModal.querySelector('.modal-overlay').addEventListener('click', () => closeModal(addTradeModal));

            closeDetailsModalBtn.addEventListener('click', () => closeModal(tradeDetailsModal));
            tradeDetailsModal.querySelector('.modal-overlay').addEventListener('click', () => closeModal(tradeDetailsModal));
            
            // --- FILE HANDLERS & GEMINI INTEGRATION ---
            const readFileAsBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    if (!file) {
                        resolve(''); // No file selected, resolve with empty string
                        return;
                    }
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                    reader.readAsDataURL(file);
                });
            };

            const displayImagePreview = (fileInput, previewElement, fileNameElement) => {
                if (fileInput.files && fileInput.files[0]) {
                    const file = fileInput.files[0];
                    fileNameElement.textContent = file.name;
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        previewElement.innerHTML = `<img src="${e.target.result}" alt="Screenshot">`;
                    };
                    reader.readAsDataURL(file);
                } else {
                    fileNameElement.textContent = 'Choose File...';
                    previewElement.innerHTML = '<span class="text-gray-500">No Screenshot Selected</span>';
                }
            };

            // Event listeners for file input change to update file name and preview
            addSetupScreenshot.addEventListener('change', (e) => displayImagePreview(e.target, addSetupScreenshotPreview, addSetupScreenshotFileName));
            addExitScreenshot.addEventListener('change', (e) => displayImagePreview(e.target, addExitScreenshotPreview, addExitScreenshotFileName));
            detailsSetupScreenshot.addEventListener('change', (e) => displayImagePreview(e.target, detailsSetupScreenshotPreview, detailsSetupScreenshotFileName));
            detailsExitScreenshot.addEventListener('change', (e) => displayImagePreview(e.target, detailsExitScreenshotPreview, detailsExitScreenshotFileName));

            const analyzeScreenshot = async (fileInput, statusElement) => {
                statusElement.textContent = 'Analyzing...';
                statusElement.style.color = 'var(--accent)';

                if (!fileInput.files || fileInput.files.length === 0) {
                    statusElement.textContent = 'No file selected for analysis.';
                    statusElement.style.color = 'var(--loss)';
                    return;
                }

                const file = fileInput.files[0];
                // Check if file size exceeds a reasonable limit for API (e.g., 4MB)
                if (file.size > 4 * 1024 * 1024) { // 4MB limit
                    statusElement.textContent = 'File too large (max 4MB). Please upload a smaller image.';
                    statusElement.style.color = 'var(--loss)';
                    return;
                }

                const base64ImageData = (await readFileAsBase64(file)).split(',')[1]; // Get base64 content without data:image/png;base64, prefix

                // Define the structured response schema
                const responseSchema = {
                    type: "OBJECT",
                    properties: {
                        "asset": { "type": "STRING", "description": "The trading asset, e.g., 'EUR/USD', 'AAPL'" },
                        "direction": { "type": "STRING", "enum": ["long", "short"], "description": "The trade direction, 'long' or 'short'" },
                        "entryPrice": { "type": "NUMBER", "description": "The entry price of the trade" },
                        "exitPrice": { "type": "NUMBER", "description": "The exit price of the trade" },
                        "pnl": { "type": "NUMBER", "description": "The profit or loss of the trade" },
                        "date": { "type": "STRING", "description": "The date of the trade in YYYY-MM-DD format" },
                        "time": { "type": "STRING", "description": "The time of the trade in HH:MM format (24-hour)" },
                        "strategy": { "type": "STRING", "description": "The trading strategy used, e.g., 'Breakout', 'Reversal'" },
                        "emotions": { "type": "STRING", "description": "Emotions felt during the trade, e.g., 'Confident', 'Anxious'" },
                        "notes": { "type": "STRING", "description": "Key notes about the trade reasoning" },
                        "lessons": { "type": "STRING", "description": "Lessons learned from the trade" }
                    },
                    "optionalProperties": ["strategy", "emotions", "notes", "lessons"] // Mark optional fields
                };

                const prompt = "Analyze this trading chart screenshot. Extract the following information: asset, trade direction (long/short), entry price, exit price, profit/loss (P&L), and the date and time of the trade. If identifiable, also extract the strategy used, emotions, notes, and lessons learned. Provide the response as a JSON object strictly following the provided schema. If a value is not found, omit the property.";

                try {
                    const chatHistory = [];
                    chatHistory.push({
                        role: "user",
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: file.type, // Use actual mime type
                                    data: base64ImageData
                                }
                            }
                        ]
                    });

                    const payload = {
                        contents: chatHistory,
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: responseSchema
                        }
                    };

                    const apiKey = ""; // Canvas will automatically provide the API key
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const result = await response.json();

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        
                        const jsonString = result.candidates[0].content.parts[0].text;
                        const parsedData = JSON.parse(jsonString);
                        console.log('Parsed data:', parsedData); // Debugging

                        // Populate form fields
                        if (parsedData.asset) document.getElementById('addAsset').value = parsedData.asset;
                        // Direction is an enum, so ensure it's a valid option
                        if (parsedData.direction && (parsedData.direction === 'long' || parsedData.direction === 'short')) {
                            document.getElementById('addDirection').value = parsedData.direction;
                        }
                        if (parsedData.entryPrice !== undefined) document.getElementById('addEntryPrice').value = parsedData.entryPrice;
                        if (parsedData.exitPrice !== undefined) document.getElementById('addExitPrice').value = parsedData.exitPrice;
                        if (parsedData.pnl !== undefined) document.getElementById('addPnl').value = parsedData.pnl;
                        if (parsedData.strategy) document.getElementById('addStrategy').value = parsedData.strategy;
                        if (parsedData.emotions) document.getElementById('addEmotions').value = parsedData.emotions;
                        if (parsedData.notes) document.getElementById('addTradingNotes').value = parsedData.notes;
                        if (parsedData.lessons) document.getElementById('addLessonsLearned').value = parsedData.lessons;

                        // Handle date and time
                        let fullDateTime = '';
                        if (parsedData.date && parsedData.time) {
                            // Assuming parsedData.date is YYYY-MM-DD and parsedData.time is HH:MM
                            fullDateTime = `${parsedData.date}T${parsedData.time}`;
                        } else if (parsedData.date) {
                            fullDateTime = `${parsedData.date}T00:00`; // Default time if only date is available
                        }
                        if (fullDateTime) {
                            document.getElementById('addDate').value = fullDateTime;
                        }

                        statusElement.textContent = 'Analysis complete!';
                        statusElement.style.color = 'var(--win)';

                    } else {
                        statusElement.textContent = 'Analysis failed: Could not extract data.';
                        statusElement.style.color = 'var(--loss)';
                        console.error('Gemini API response structure unexpected or empty:', result);
                    }
                } catch (error) {
                    statusElement.textContent = `Analysis error: ${error.message}`;
                    statusElement.style.color = 'var(--loss)';
                    console.error('Error analyzing screenshot:', error);
                }
            };

            // Attach event listeners for analyze buttons
            analyzeAddSetupBtn.addEventListener('click', () => analyzeScreenshot(addSetupScreenshot, addSetupAnalysisStatus));
            analyzeAddExitBtn.addEventListener('click', () => analyzeScreenshot(addExitScreenshot, addExitAnalysisStatus));


            // --- RENDERING & CALCULATIONS ---
            const calculateResult = (pnl) => {
                if (pnl > 0) return 'win';
                if (pnl < 0) return 'loss';
                return 'breakeven';
            };

            const calculateRR = (risk, pnl) => {
                if (risk > 0 && pnl > 0) {
                    return (pnl / risk).toFixed(2);
                }
                return 0;
            };

            const renderTradeLog = (tradesToRender) => {
                tradeLogBody.innerHTML = '';
                if (tradesToRender.length === 0) {
                    noTradesMessage.classList.remove('hidden');
                    return;
                }
                noTradesMessage.classList.add('hidden');

                tradesToRender.forEach(trade => {
                    const result = calculateResult(trade.pnl);
                    const row = document.createElement('tr');
                    row.className = 'bg-white border-b hover:bg-gray-50 cursor-pointer';
                    row.setAttribute('data-trade-id', trade.id); // Add data attribute for easy lookup
                    row.innerHTML = `
                        <td class="px-6 py-4">${new Date(trade.date).toLocaleDateString()}</td>
                        <td class="px-6 py-4 font-medium text-gray-900">${trade.asset}</td>
                        <td class="px-6 py-4">
                            <span class="${trade.direction === 'long' ? 'win-text' : 'loss-text'} font-semibold">
                                ${trade.direction.charAt(0).toUpperCase() + trade.direction.slice(1)}
                            </span>
                        </td>
                        <td class="px-6 py-4">${trade.strategy}</td>
                        <td class="px-6 py-4 font-medium ${result === 'win' ? 'win-text' : result === 'loss' ? 'loss-text' : 'breakeven-text'}">
                            $${trade.pnl.toFixed(2)}
                        </td>
                        <td class="px-6 py-4">${calculateRR(trade.risk, trade.pnl)}</td>
                        <td class="px-6 py-4">
                             <span class="px-2 py-1 font-semibold leading-tight text-xs rounded-full ${result === 'win' ? 'bg-green-100 win-text' : result === 'loss' ? 'bg-red-100 loss-text' : 'bg-gray-100 breakeven-text'}">
                                ${result.charAt(0).toUpperCase() + result.slice(1)}
                            </span>
                        </td>
                    `;
                    tradeLogBody.appendChild(row);
                });
            };

            const renderKPIs = () => {
                const totalTrades = trades.length;
                const totalPnl = trades.reduce((sum, trade) => sum + trade.pnl, 0);
                const wins = trades.filter(t => t.pnl > 0).length;
                const winRate = totalTrades > 0 ? (wins / totalTrades) * 100 : 0;
                const totalRR = trades.reduce((sum, trade) => sum + parseFloat(calculateRR(trade.risk, trade.pnl)), 0);
                const avgRr = totalTrades > 0 ? totalRR / totalTrades : 0;
                
                kpiTotalTrades.textContent = totalTrades;
                kpiTotalPnl.textContent = `$${totalPnl.toFixed(2)}`;
                kpiTotalPnl.className = `text-2xl font-bold mt-1 ${totalPnl >= 0 ? 'win-text' : 'loss-text'}`;
                kpiWinRate.textContent = `${winRate.toFixed(1)}%`;
                kpiAvgRr.textContent = avgRr.toFixed(2);
            };

            const populateFilters = () => {
                const strategies = [...new Set(trades.map(t => t.strategy))];
                filterStrategy.innerHTML = '<option value="all">All Strategies</option>';
                strategies.forEach(s => {
                    const option = document.createElement('option');
                    option.value = s;
                    option.textContent = s;
                    filterStrategy.appendChild(option);
                });
            };

            const renderAll = () => {
                const sortedTrades = [...trades].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                const strategyFilter = filterStrategy.value;
                const resultFilter = filterResult.value;

                const filteredTrades = sortedTrades.filter(trade => {
                    const strategyMatch = strategyFilter === 'all' || trade.strategy === strategyFilter;
                    const resultMatch = resultFilter === 'all' || calculateResult(trade.pnl) === resultFilter;
                    return strategyMatch && resultMatch;
                });

                renderTradeLog(filteredTrades);
                renderKPIs();
                populateFilters();
                renderPnlChart(sortedTrades); // Pass sorted trades to chart
                renderWinLossChart();
                renderStrategyChart();
            };

            // --- CHART RENDERING ---
            const getChartColors = () => {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                return {
                    accent: isDark ? '#63B3ED' : '#2B6CB0',
                    win: isDark ? '#38A169' : '#2F855A',
                    loss: isDark ? '#E53E3E' : '#C53030',
                    breakeven: isDark ? '#A0AEC0' : '#4A5568',
                    text: isDark ? '#E2E8F0' : '#212529',
                    grid: isDark ? 'rgba(160, 174, 192, 0.2)' : 'rgba(0, 0, 0, 0.1)',
                };
            };

            const renderPnlChart = (sortedTrades) => {
                const ctx = document.getElementById('pnlChart').getContext('2d');
                if (pnlChartInstance) pnlChartInstance.destroy();
                const colors = getChartColors();
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark'; 

                let cumulativePnl = 0;
                const chartData = sortedTrades.reverse().map(trade => {
                    cumulativePnl += trade.pnl;
                    return { x: new Date(trade.date), y: cumulativePnl };
                });

                pnlChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Cumulative P&L',
                            data: chartData,
                            borderColor: colors.accent,
                            backgroundColor: isDark ? 'rgba(99, 179, 237, 0.1)' : 'rgba(43, 108, 176, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            fill: true,
                            pointRadius: 2,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'day' },
                                title: { display: true, text: 'Date', color: colors.text },
                                ticks: { color: colors.text },
                                grid: { color: colors.grid }
                            },
                            y: {
                                title: { display: true, text: 'Cumulative P&L ($)', color: colors.text },
                                ticks: {
                                    callback: value => `$${value}`,
                                    color: colors.text
                                },
                                grid: { color: colors.grid }
                            }
                        },
                        plugins: {
                            title: { display: true, text: 'P&L Over Time', font: { size: 16 }, color: colors.text },
                            legend: { display: false }
                        }
                    }
                });
            };

            const renderWinLossChart = () => {
                const ctx = document.getElementById('winLossChart').getContext('2d');
                if (winLossChartInstance) winLossChartInstance.destroy();
                const colors = getChartColors();
                
                const wins = trades.filter(t => t.pnl > 0).length;
                const losses = trades.filter(t => t.pnl < 0).length;
                const breakevens = trades.filter(t => t.pnl === 0).length;

                winLossChartInstance = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Wins', 'Losses', 'Break Evens'],
                        datasets: [{
                            data: [wins, losses, breakevens],
                            backgroundColor: [colors.win, colors.loss, colors.breakeven],
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: { display: true, text: 'Trade Outcomes', font: { size: 16 }, color: colors.text },
                            legend: { 
                                position: 'bottom',
                                labels: {
                                    color: colors.text
                                }
                            }
                        }
                    }
                });
            };
            
            const renderStrategyChart = () => {
                const ctx = document.getElementById('strategyChart').getContext('2d');
                if (strategyChartInstance) strategyChartInstance.destroy();
                const colors = getChartColors();

                const strategyData = trades.reduce((acc, trade) => {
                    if (!acc[trade.strategy]) {
                        acc[trade.strategy] = { pnl: 0 };
                    }
                    acc[trade.strategy].pnl += trade.pnl;
                    return acc;
                }, {});

                const labels = Object.keys(strategyData);
                const data = labels.map(label => strategyData[label].pnl);
                
                strategyChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Total P&L by Strategy',
                            data: data,
                            backgroundColor: data.map(pnl => pnl >= 0 ? colors.win : colors.loss),
                            borderColor: data.map(pnl => pnl >= 0 ? colors.win : colors.loss),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        indexAxis: 'y',
                        responsive: true,
                        maintainAspectRatio: false,
                         plugins: {
                            title: { display: true, text: 'Strategy Performance', font: { size: 16 }, color: colors.text },
                            legend: { display: false }
                        },
                        scales: {
                             x: {
                                title: { display: true, text: 'Total P&L ($)', color: colors.text },
                                ticks: { color: colors.text },
                                grid: { color: colors.grid }
                            },
                            y: {
                                ticks: { color: colors.text },
                                grid: { color: colors.grid }
                            }
                        }
                    }
                });
            };

            // --- TRADE DETAILS & EDITING ---
            const showTradeDetails = (tradeId) => {
                const trade = trades.find(t => t.id === tradeId);
                if (!trade) return;

                detailsTradeId.value = trade.id;
                detailsAsset.value = trade.asset;
                detailsDirection.value = trade.direction;
                detailsStrategy.value = trade.strategy;
                // Set datetime-local value correctly
                const tradeDate = new Date(trade.date);
                tradeDate.setMinutes(tradeDate.getMinutes() - tradeDate.getTimezoneOffset());
                detailsDate.value = tradeDate.toISOString().slice(0, 16);

                detailsEntryPrice.value = trade.entryPrice;
                detailsExitPrice.value = trade.exitPrice;
                detailsStopLoss.value = trade.stopLoss;
                detailsTakeProfit.value = trade.takeProfit;
                detailsRisk.value = trade.risk;
                detailsPnl.value = trade.pnl;
                detailsEmotions.value = trade.emotions;
                detailsTradingNotes.value = trade.notes;
                detailsLessonsLearned.value = trade.lessons;
                
                // Clear file inputs, as they can't be pre-filled for security reasons
                detailsSetupScreenshot.value = ''; 
                detailsExitScreenshot.value = '';
                detailsSetupScreenshotFileName.textContent = 'Choose File...';
                detailsExitScreenshotFileName.textContent = 'Choose File...';


                // Display screenshots or placeholders
                detailsSetupScreenshotPreview.innerHTML = trade.setupScreenshot
                    ? `<img src="${trade.setupScreenshot}" alt="Setup Screenshot" onerror="this.onerror=null;this.src='https://placehold.co/300x200/F0F0F0/888888?text=Error+Loading+Image';">`
                    : '<span class="text-gray-500">No Setup Screenshot</span>';
                detailsExitScreenshotPreview.innerHTML = trade.exitScreenshot
                    ? `<img src="${trade.exitScreenshot}" alt="Exit Screenshot" onerror="this.onerror=null;this.src='https://placehold.co/300x200/F0F0F0/888888?text=Error+Loading+Image';">`
                    : '<span class="text-gray-500">No Exit Screenshot</span>';

                openModal(tradeDetailsModal);
            };

            // --- EVENT LISTENERS ---
            addTradeForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                // Read files as Base64 asynchronously
                const setupScreenshotBase64 = await readFileAsBase64(addSetupScreenshot.files[0]);
                const exitScreenshotBase64 = await readFileAsBase64(addExitScreenshot.files[0]);

                const newTrade = {
                    id: trades.length > 0 ? Math.max(...trades.map(t => t.id)) + 1 : 1,
                    date: document.getElementById('addDate').value,
                    asset: document.getElementById('addAsset').value,
                    direction: document.getElementById('addDirection').value,
                    strategy: document.getElementById('addStrategy').value,
                    entryPrice: parseFloat(document.getElementById('addEntryPrice').value),
                    exitPrice: parseFloat(document.getElementById('addExitPrice').value),
                    stopLoss: parseFloat(document.getElementById('addStopLoss').value),
                    takeProfit: parseFloat(document.getElementById('addTakeProfit').value),
                    risk: parseFloat(document.getElementById('addRisk').value),
                    pnl: parseFloat(document.getElementById('addPnl').value),
                    emotions: document.getElementById('addEmotions').value,
                    notes: document.getElementById('addTradingNotes').value,
                    lessons: document.getElementById('addLessonsLearned').value,
                    setupScreenshot: setupScreenshotBase64,
                    exitScreenshot: exitScreenshotBase64,
                };

                trades.push(newTrade);
                closeModal(addTradeModal);
                renderAll();
            });
            
            tradeDetailsForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const idToUpdate = parseInt(detailsTradeId.value);
                const tradeIndex = trades.findIndex(t => t.id === idToUpdate);

                if (tradeIndex > -1) {
                    const currentTrade = trades[tradeIndex];

                    // Determine if new files are selected or keep existing Base64
                    const updatedSetupScreenshot = detailsSetupScreenshot.files[0] 
                        ? await readFileAsBase64(detailsSetupScreenshot.files[0]) 
                        : currentTrade.setupScreenshot;
                    const updatedExitScreenshot = detailsExitScreenshot.files[0] 
                        ? await readFileAsBase64(detailsExitScreenshot.files[0]) 
                        : currentTrade.exitScreenshot;

                    trades[tradeIndex] = {
                        id: idToUpdate,
                        date: detailsDate.value,
                        asset: detailsAsset.value,
                        direction: detailsDirection.value,
                        strategy: detailsStrategy.value,
                        entryPrice: parseFloat(detailsEntryPrice.value),
                        exitPrice: parseFloat(detailsExitPrice.value),
                        stopLoss: parseFloat(detailsStopLoss.value),
                        takeProfit: parseFloat(detailsTakeProfit.value),
                        risk: parseFloat(detailsRisk.value),
                        pnl: parseFloat(detailsPnl.value),
                        emotions: detailsEmotions.value,
                        notes: detailsTradingNotes.value,
                        lessons: detailsLessonsLearned.value,
                        setupScreenshot: updatedSetupScreenshot,
                        exitScreenshot: updatedExitScreenshot,
                    };
                    closeModal(tradeDetailsModal);
                    renderAll();
                }
            });

            deleteTradeBtn.addEventListener('click', function() {
                const idToDelete = parseInt(detailsTradeId.value);
                if (confirm('Are you sure you want to delete this trade?')) {
                    trades = trades.filter(t => t.id !== idToDelete);
                    closeModal(tradeDetailsModal);
                    renderAll();
                }
            });

            filterStrategy.addEventListener('change', renderAll);
            filterResult.addEventListener('change', renderAll);

            // Event delegation for trade log rows
            tradeLogBody.addEventListener('click', function(e) {
                const row = e.target.closest('tr');
                if (row && row.dataset.tradeId) {
                    showTradeDetails(parseInt(row.dataset.tradeId));
                }
            });

            // Initial Render
            renderAll();
        });
    </script>
</body>
</html>
